<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Trip report</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg: var(--tg-theme-secondary-bg-color, #0f1220);
    --text: var(--tg-theme-text-color, #e6e6e6);
    --muted: var(--tg-theme-hint-color, #9aa3b2);
    --accent: var(--tg-theme-button-color, #4e8cff);
    --accentText: var(--tg-theme-button-text-color, #fff);
    --card: rgba(255,255,255,0.06);
    --stroke: rgba(255,255,255,0.12);
    --shadow: 0 10px 30px rgba(0,0,0,0.25);
    --radius: 18px;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1200px 600px at 100% -10%, rgba(78,140,255,0.25), transparent 60%),
      radial-gradient(1000px 500px at -10% 110%, rgba(168,85,247,0.20), transparent 60%),
      var(--bg);
    display:grid; place-items:start center; padding:16px;
  }
  main.card{
    width:100%; max-width:720px; background:var(--card);
    border:1px solid var(--stroke); border-radius:var(--radius);
    box-shadow:var(--shadow); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
    padding:20px; margin-top:12px;
  }
  h1{font-size:20px; margin:0 0 2px}
  .sub{color:var(--muted); font-size:13px; margin-bottom:8px}
  .step-title{font-weight:700; margin:14px 0 8px}
  label{display:block; font-size:14px; margin:10px 0 6px}
  input,select,textarea{
    width:100%; padding:12px 12px; border-radius:12px;
    border:1px solid var(--stroke); background:rgba(255,255,255,0.05); color:var(--text);
    outline:none;
  }
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .row-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
  .btn{
    margin-top:14px; width:100%; border-radius:14px; padding:14px 16px;
    border:1px solid var(--stroke); background:var(--accent); color:var(--accentText);
    font-weight:700; cursor:pointer; transition:transform .12s ease;
  }
  .btn.secondary{background:transparent; color:var(--text)}
  .btn.small{width:auto; padding:8px 12px; border-radius:10px; font-weight:600}
  .actions{display:flex; gap:10px; margin-top:14px}
  .table{border:1px solid var(--stroke); border-radius:12px; overflow:hidden}
  .thead,.trow{display:grid; grid-template-columns:1.2fr 1.2fr 1.2fr .7fr .7fr auto; gap:6px; padding:8px}
  .thead{background:rgba(255,255,255,0.04); font-weight:700; font-size:13px}
  .trow{align-items:center; border-top:1px solid var(--stroke)}
  .muted{color:var(--muted); font-size:12px}
  .alert{display:none; margin-top:10px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.15); background: rgba(255,107,107,0.12); color:#ffd7d7; font-size:13px}
  .ok{display:none; margin-top:10px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.15); background: rgba(100,255,160,0.12); color:#c8ffd7; font-size:13px}
  .hidden{display:none}
  .spacer{height:6px}
  .right{justify-self:end}
</style>
</head>
<body>
  <main class="card">
    <h1>Trip report</h1>
    <div class="sub">Заполни поездку, загрузки и расходы. Телеграм-ID подхватим автоматически.</div>

    <!-- Step 1 -->
    <section id="step1">
      <div class="step-title">Trip start</div>
      <label>Start location</label>
      <input id="start_loc" placeholder="City, ST" />

      <div class="row">
        <div>
          <label>Date</label>
          <input id="start_date" type="date" />
        </div>
        <div>
          <label>Start mileage *</label>
          <input id="start_mi" type="number" min="0" required />
        </div>
      </div>

      <div class="step-title">Trip finish</div>
      <label>Finish location</label>
      <input id="finish_loc" placeholder="City, ST" />

      <div class="row">
        <div>
          <label>Date</label>
          <input id="finish_date" type="date" />
        </div>
        <div>
          <label>Finish mileage *</label>
          <input id="finish_mi" type="number" min="0" required />
        </div>
      </div>

      <div class="actions">
        <button id="toLoads" class="btn">Next → Loads</button>
        <button id="backMenu1" class="btn secondary" type="button">Back to menu</button>
      </div>
    </section>

    <!-- Step 2: Loads -->
    <section id="step2" class="hidden">
      <div class="step-title">Loads</div>
      <div class="muted">Добавляй строки по мере необходимости.</div>

      <div class="table" id="loadsTable">
        <div class="thead">
          <div>Date</div><div>Pickup location</div><div>Delivery location</div><div>Partial</div><div>Tarp</div><div></div>
        </div>
        <!-- rows mount here -->
      </div>
      <div class="spacer"></div>
      <button id="addLoad" class="btn small">+ Add load</button>

      <div class="actions">
        <button id="toExpenses" class="btn">Next → Expenses</button>
        <button id="back1" class="btn secondary">← Back</button>
      </div>
    </section>

    <!-- Step 3: Expenses -->
    <section id="step3" class="hidden">
      <div class="step-title">Expenses</div>
      <div class="muted">Добавляй строки по мере необходимости.</div>

      <div class="table" id="expTable">
        <div class="thead" style="grid-template-columns:2fr 1fr auto;">
          <div>Name</div><div>Price</div><div></div>
        </div>
        <!-- rows -->
      </div>
      <div class="spacer"></div>
      <button id="addExp" class="btn small">+ Add expense</button>

      <div class="actions">
        <button id="toReview" class="btn">Next → Review</button>
        <button id="back2" class="btn secondary">← Back</button>
      </div>
    </section>

    <!-- Step 4: Review -->
    <section id="step4" class="hidden">
      <div class="step-title">Review & submit</div>
      <div id="reviewBox" class="muted" style="white-space:pre-wrap;border:1px solid var(--stroke);border-radius:12px;padding:12px;background:rgba(255,255,255,0.03)"></div>

      <div class="actions">
        <button id="submit" class="btn">Submit</button>
        <button id="back3" class="btn secondary">← Back</button>
      </div>
    </section>

    <div id="alert" class="alert"></div>
    <div id="ok" class="ok"></div>
  </main>

<script>
const tg = window.Telegram?.WebApp; tg?.ready(); tg?.expand();

const WEBHOOK = "https://venture666.app.n8n.cloud/webhook/a20cec7e-fc93-4a5c-b314-935c5009b235"; // <- n8n webhook

const $ = sel => document.querySelector(sel);
const create = (tag, attrs={}) => Object.assign(document.createElement(tag), attrs);

// Simple nav between steps
const steps = [$('#step1'), $('#step2'), $('#step3'), $('#step4')];
let current = 0;
function go(i){ steps[current].classList.add('hidden'); current=i; steps[current].classList.remove('hidden'); window.scrollTo({top:0,behavior:'instant'}); }
$('#toLoads').onclick = () => {
  if (!validateStep1()) return;
  go(1);
};
$('#toExpenses').onclick = () => go(2);
$('#toReview').onclick = () => { buildReview(); go(3); };
$('#back1').onclick = () => go(0);
$('#back2').onclick = () => go(1);
$('#back3').onclick = () => go(2);
$('#backMenu1').onclick = () => location.href = "./"; // твой индекс-меню

// Loads table
const loadsTable = $('#loadsTable');
function addLoadRow(row={}) {
  const wrapper = create('div', { className:'trow' });
  wrapper.style.gridTemplateColumns = '1.2fr 1.2fr 1.2fr .7fr .7fr auto';

  const d = create('input', { type:'date', value: row.date||'' });
  const p = create('input', { placeholder:'Pickup' , value: row.pickup||'' });
  const q = create('input', { placeholder:'Delivery', value: row.delivery||'' });
  const partial = create('select'); partial.innerHTML = '<option value=""></option><option>No</option><option>Yes</option>'; partial.value=row.partial||'';
  const tarp    = create('select'); tarp.innerHTML    = '<option value=""></option><option>No</option><option>Yes</option>'; tarp.value=row.tarp||'';
  const del = create('button', { className:'btn small secondary right', type:'button', textContent:'Remove' });
  del.onclick = () => wrapper.remove();

  [d,p,q,partial,tarp,del].forEach(el => wrapper.appendChild(el));
  loadsTable.appendChild(wrapper);
}
addLoadRow(); // first visible

$('#addLoad').onclick = () => addLoadRow();

// Expenses table
const expTable = $('#expTable');
function addExpRow(row={}) {
  const wrapper = create('div', { className:'trow' });
  wrapper.style.gridTemplateColumns = '2fr 1fr auto';
  const name  = create('input', { placeholder:'Name', value: row.name||'' });
  const price = create('input', { type:'number', min:'0', step:'0.01', placeholder:'0.00', value: row.price||'' });
  const del = create('button', { className:'btn small secondary right', type:'button', textContent:'Remove' });
  del.onclick = () => wrapper.remove();
  [name, price, del].forEach(el => wrapper.appendChild(el));
  expTable.appendChild(wrapper);
}
addExpRow();

$('#addExp').onclick = () => addExpRow();

function getLoads(){
  const rows = [...loadsTable.querySelectorAll('.trow')].slice(1); // skip header row
  return rows.map(r => {
    const [d,p,q,partial,tarp] = r.querySelectorAll('input,select');
    return { date:d.value, pickup:p.value, delivery:q.value, partial:partial.value, tarp:tarp.value };
  }).filter(x => Object.values(x).some(v => String(v||'').trim() !== ''));
}
function getExpenses(){
  const rows = [...expTable.querySelectorAll('.trow')].slice(1);
  return rows.map(r=>{
    const [name,price] = r.querySelectorAll('input');
    return { name:name.value, price:price.value };
  }).filter(x => (x.name||x.price));
}

function validateStep1(){
  const startMi = Number($('#start_mi').value);
  const finishMi = Number($('#finish_mi').value);
  if (!Number.isFinite(startMi) || startMi < 0) return err('Start mileage is required');
  if (!Number.isFinite(finishMi) || finishMi < 0) return err('Finish mileage is required');
  return true;
}

// Review box
function buildReview(){
  const payload = collectPayload();
  $('#reviewBox').textContent = JSON.stringify(payload, null, 2);
}

function collectPayload(){
  const meta = {
    initData: tg?.initData || "",
    user: tg?.initDataUnsafe?.user || null
  };
  const trip = {
    start_location: $('#start_loc').value,
    start_date: $('#start_date').value,
    start_mileage: Number($('#start_mi').value||0),
    finish_location: $('#finish_loc').value,
    finish_date: $('#finish_date').value,
    finish_mileage: Number($('#finish_mi').value||0),
  };
  return {
    _tg_meta: meta,
    trip,
    loads: getLoads(),
    expenses: getExpenses(),
    client_token: getClientToken() // защита от дабл-кликов/повторов
  };
}

// --- one-shot отправка: лок локально + in-flight ---
let inFlight = false;
function lock(on){
  inFlight = on;
  $('#submit').disabled = on;
  $('#submit').textContent = on ? 'Submitting…' : 'Submit';
}
function err(m){ const a=$('#alert'); a.textContent=m; a.style.display='block'; setTimeout(()=>a.style.display='none', 5000); return false; }
function ok(m){ const o=$('#ok'); o.textContent=m; o.style.display='block'; }

const LS_KEY = 'trip_lock_v1';
function getClientToken(){
  const uid = tg?.initDataUnsafe?.user?.id || 'anon';
  const now = Date.now();
  // 30сек блок по пользователю
  const last = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
  if (last[uid] && (now - last[uid] < 30_000)) return last._token || String(last[uid]);
  const token = `${uid}_${now}`;
  localStorage.setItem(LS_KEY, JSON.stringify({[uid]: now, _token: token}));
  return token;
}

$('#submit').onclick = async () => {
  if (inFlight) return;
  if (!validateStep1()) return;

  const payload = collectPayload();
  lock(true);

  try{
    const r = await fetch(WEBHOOK, {
      method:'POST',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error('Bad HTTP');
    $('main .card'); // no-op for style scanners
    ok('Thanks! Your trip was submitted.');
    // прячем всё и показываем только кнопку назад
    steps.forEach(s=>s.classList.add('hidden'));
    const done = document.createElement('div');
    done.innerHTML = `
      <div class="step-title">All set ✅</div>
      <div class="muted">You can go back to menu.</div>
      <div class="actions"><button class="btn secondary" onclick="location.href='./'">Back to menu</button></div>
    `;
    document.querySelector('main.card').appendChild(done);
  }catch(e){
    err('Error. Please try again in ~30 seconds.');
    lock(false);
  }
};
</script>
</body>
</html>
