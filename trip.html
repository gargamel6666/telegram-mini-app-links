<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Trip report</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --bg:#0f1115; --card:#1a1f2b; --muted:#8fa0b9; --text:#e7edf7;
    --primary:#3b82f6; --primary-600:#2563eb; --err:#f43f5e;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.35 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Arial;}
  .wrap{max-width:720px;margin:0 auto;padding:20px 16px 32px;}
  .section{background:linear-gradient(180deg,rgba(255,255,255,.04),transparent);padding:16px;border-radius:24px;border:1px solid rgba(255,255,255,.06);box-shadow:0 8px 32px rgba(0,0,0,.35)}
  .title{font-weight:700;font-size:22px;margin:0 0 6px}
  .hint{color:var(--muted);margin:0 0 16px}
  .grid{display:grid;gap:12px}
  .grid-2{grid-template-columns:1fr 1fr}
  .card{background:#151925;border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:14px}
  label{display:block;margin:4px 2px 6px 2px;color:var(--muted);font-size:13px}
  input{width:100%;box-sizing:border-box;border:1px solid rgba(255,255,255,.12);background:#0f1422;color:var(--text);border-radius:14px;padding:14px 14px;font-size:16px}
  input[type="date"]{appearance:none;-webkit-appearance:none}
  .btn{background:var(--primary);color:white;border:none;border-radius:14px;padding:14px 18px;font-weight:600}
  .btn:active{transform:translateY(1px)}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
  .chip{background:#0e1423;border:1px solid rgba(255,255,255,.12);color:var(--text);border-radius:999px;padding:8px 12px;font-weight:600}
  .row{display:flex;gap:12px}
  .footer{display:flex;gap:12px;justify-content:space-between;margin-top:16px}
  .err{color:var(--err);margin:6px 2px 0 2px;font-size:14px}
  [hidden]{display:none !important}

  /* review pretty view */
  .review-block{margin-top:12px}
  .rv-title{font-weight:700;margin:6px 0 8px}
  .kv{border:1px solid rgba(255,255,255,.08);background:#0f1422;border-radius:14px;overflow:hidden}
  .kv-row{display:flex;gap:12px;padding:10px 12px;border-top:1px solid rgba(255,255,255,.06)}
  .kv-row:first-child{border-top:none}
  .kv-k{min-width:140px;color:var(--muted)}
  .rv-load{margin-top:10px}
  details.mono{margin-top:12px}
  details summary{cursor:pointer;color:var(--muted)}
  .mono pre{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b0f18;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;color:#cfe2ff}
</style>
</head>
<body>
<div class="wrap">

  <!-- STEP 1: Trip -->
  <section id="step_trip" class="section">
    <div class="title">Trip report</div>
    <p class="hint">Fill out trip, loads and expenses. Your Telegram ID will be captured automatically.</p>

    <div class="grid">
      <div class="card">
        <label>Start location</label>
        <input id="start_location" placeholder="City, ST">
      </div>
      <div class="grid grid-2">
        <div class="card">
          <label>Start date</label>
          <input id="start_date" type="date">
        </div>
        <div class="card">
          <label>Start mileage *</label>
          <input id="start_mileage" type="number" min="0" step="1" required>
        </div>
      </div>

      <div class="card">
        <label>Finish location</label>
        <input id="finish_location" placeholder="City, ST">
      </div>
      <div class="grid grid-2">
        <div class="card">
          <label>Finish date</label>
          <input id="finish_date" type="date">
        </div>
        <div class="card">
          <label>Finish mileage *</label>
          <input id="finish_mileage" type="number" min="0" step="1" required>
        </div>
      </div>
    </div>

    <div id="trip_err" class="err" hidden></div>

    <div class="footer">
      <button class="btn" type="button" onclick="goStep('loads')">Next → Loads</button>
      <button class="btn ghost" type="button" onclick="backToMenu()">Back to menu</button>
    </div>
  </section>

  <!-- STEP 2: Loads -->
  <section id="step_loads" class="section" hidden>
    <div class="title">Loads</div>
    <p class="hint">Add rows as needed.</p>

    <div id="loadChips" class="chips"></div>
    <div id="loadCard" class="card"></div>

    <div id="loads_err" class="err" hidden></div>

    <div class="row" style="margin-top:12px">
      <button class="btn ghost" type="button" onclick="removeCurrentLoad()">Remove load</button>
      <button class="btn" type="button" onclick="addLoad()">+ Add load</button>
    </div>

    <div class="footer">
      <button class="btn" type="button" onclick="goStep('expenses')">Next → Expenses</button>
      <button class="btn ghost" type="button" onclick="goStep('trip')">← Back</button>
    </div>
  </section>

  <!-- STEP 3: Expenses -->
  <section id="step_expenses" class="section" hidden>
    <div class="title">Expenses</div>
    <p class="hint">Add rows as needed.</p>

    <div id="expenseList"></div>
    <div class="row" style="margin-top:12px">
      <button class="btn" type="button" onclick="addExpense()">+ Add expense</button>
    </div>

    <div class="footer">
      <button class="btn" type="button" onclick="goStep('review')">Next → Review</button>
      <button class="btn ghost" type="button" onclick="goStep('loads')">← Back</button>
    </div>
  </section>

  <!-- STEP 4: Review -->
  <section id="step_review" class="section" hidden>
    <div class="title">Review & submit</div>
    <div id="reviewBox" class="review-block"></div>

    <details class="mono">
      <summary>Show raw JSON</summary>
      <pre id="rawJson"></pre>
    </details>

    <div id="submit_err" class="err" hidden></div>

    <div class="footer">
      <button id="submitBtn" class="btn" type="button" onclick="submitTrip()">Submit</button>
      <button class="btn ghost" type="button" onclick="goStep('expenses')">← Back</button>
    </div>
  </section>

</div>

<script>
const tg = window.Telegram?.WebApp;
if (tg){ tg.ready(); tg.expand(); tg.MainButton.hide(); }

const WEBHOOK_URL = 'https://venture666.app.n8n.cloud/webhook/a20cec7e-fc93-4a5c-b314-935c5009b235';

const state = {
  step:'trip',
  trip:{ start_location:'', start_date:'', start_mileage:'', finish_location:'', finish_date:'', finish_mileage:'' },
  loads:[],
  expenses:[],
  currentLoadIndex:0,
  client_token:''
};

function showStep(id){
  ['trip','loads','expenses','review'].forEach(s=>document.getElementById('step_'+s).hidden = (s!==id));
  state.step=id;
  if (id==='loads') renderLoads();
  if (id==='expenses') renderExpenses();
  if (id==='review') renderReview();
}
function backToMenu(){ if (tg) tg.close(); }

// Trip
function saveTripFromInputs(){
  state.trip.start_location=document.getElementById('start_location').value.trim();
  state.trip.start_date=document.getElementById('start_date').value;
  state.trip.start_mileage=document.getElementById('start_mileage').value;
  state.trip.finish_location=document.getElementById('finish_location').value.trim();
  state.trip.finish_date=document.getElementById('finish_date').value;
  state.trip.finish_mileage=document.getElementById('finish_mileage').value;
}
function validateTrip(){
  saveTripFromInputs();
  const e=document.getElementById('trip_err');
  if (state.trip.start_mileage===''||state.trip.finish_mileage===''){ e.textContent='Start mileage and Finish mileage are required.'; e.hidden=false; return false; }
  e.hidden=true; return true;
}

// Loads
function addLoad(){ saveCurrentLoad(); state.loads.push({date:'',pickup:'',delivery:'',partial:'',tarp:''}); state.currentLoadIndex=state.loads.length-1; renderLoads(); }
function removeCurrentLoad(){
  saveCurrentLoad();
  if (state.loads.length<=1){ state.loads[0]={date:'',pickup:'',delivery:'',partial:'',tarp:''}; state.currentLoadIndex=0; }
  else { state.loads.splice(state.currentLoadIndex,1); state.currentLoadIndex=Math.max(0,state.currentLoadIndex-1); }
  renderLoads();
}
function saveCurrentLoad(){
  const i=state.currentLoadIndex, wrap=document.getElementById('loadCard'); if (!wrap||state.loads.length===0) return;
  const L=state.loads[i]||(state.loads[i]={});
  L.date=wrap.querySelector('[name="date"]')?.value||'';
  L.pickup=wrap.querySelector('[name="pickup"]')?.value.trim()||'';
  L.delivery=wrap.querySelector('[name="delivery"]')?.value.trim()||'';
  L.partial=wrap.querySelector('[name="partial"]')?.value||'';
  L.tarp=wrap.querySelector('[name="tarp"]')?.value||'';
}
function isLoadFilled(L){
  const hasT=(s)=>s&&String(s).trim().length>0, hasN=(v)=>v!==''&&!Number.isNaN(Number(v));
  return hasT(L.pickup)||hasT(L.delivery)||hasT(L.date)||hasN(L.partial)||hasN(L.tarp);
}
function validateLoads(){
  saveCurrentLoad();
  const err=document.getElementById('loads_err');
  if (state.loads.length===0){ err.textContent='Add at least 1 load.'; err.hidden=false; return false; }
  if (!state.loads.some(isLoadFilled)){ err.textContent='Please fill at least one field in Load 1 (e.g., Pickup, Delivery or Date).'; err.hidden=false; return false; }
  err.hidden=true; return true;
}
function renderLoads(){
  if (state.loads.length===0) state.loads=[{date:'',pickup:'',delivery:'',partial:'',tarp:''}];
  const chips=document.getElementById('loadChips'); chips.innerHTML='';
  state.loads.forEach((_,idx)=>{ const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=`Load ${idx+1}`; if (idx===state.currentLoadIndex) b.style.background='var(--primary)'; b.onclick=()=>{ saveCurrentLoad(); state.currentLoadIndex=idx; renderLoads(); }; chips.appendChild(b); });

  const i=state.currentLoadIndex, L=state.loads[i]; const card=document.getElementById('loadCard');
  card.innerHTML=`
    <div class="grid">
      <div>
        <label>Date</label>
        <input type="date" name="date" value="${L.date||''}">
      </div>
      <div>
        <label>Pickup location</label>
        <input name="pickup" placeholder="City, ST" value="${esc(L.pickup||'')}">
      </div>
      <div>
        <label>Delivery location</label>
        <input name="delivery" placeholder="City, ST" value="${esc(L.delivery||'')}">
      </div>
      <div class="grid grid-2">
        <div>
          <label>Partial (qty)</label>
          <input type="number" min="0" step="1" name="partial" value="${L.partial||''}">
        </div>
        <div>
          <label>Tarp (qty)</label>
          <input type="number" min="0" step="1" name="tarp" value="${L.tarp||''}">
        </div>
      </div>
    </div>`;
}

// Expenses
function addExpense(){ state.expenses.push({name:'',price:''}); renderExpenses(); }
function removeExpense(i){ state.expenses.splice(i,1); renderExpenses(); }
function renderExpenses(){
  const box=document.getElementById('expenseList'); if (state.expenses.length===0) state.expenses=[{name:'',price:''}]; box.innerHTML='';
  state.expenses.forEach((ex,idx)=>{ const row=document.createElement('div'); row.className='card'; row.innerHTML=`
    <div class="grid grid-2">
      <div>
        <label>Name</label>
        <input value="${esc(ex.name||'')}" oninput="state.expenses[${idx}].name=this.value">
      </div>
      <div>
        <label>Price</label>
        <input type="number" min="0" step="0.01" value="${ex.price||''}" oninput="state.expenses[${idx}].price=this.value">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn ghost" type="button" onclick="removeExpense(${idx})">Remove</button>
    </div>`; box.appendChild(row); });
}

// Navigation
function goStep(id){
  if (id==='loads' && !validateTrip()) return;
  if ((id==='expenses'||id==='review') && !validateLoads()) return;
  showStep(id);
}

// Review
function renderReview(){
  saveTripFromInputs(); saveCurrentLoad();
  const payload = buildPayload(true);
  // pretty view:
  const rv = [];
  const u = payload._tg_meta?.user;
  if (u){
    rv.push(`<div class="rv-title">User</div>
      <div class="kv">
        <div class="kv-row"><div class="kv-k">Telegram</div><div>@${esc(u.username||'')}</div></div>
        <div class="kv-row"><div class="kv-k">User ID</div><div>${u.id||''}</div></div>
      </div>`);
  }

  // Trip
  const t = payload.trip||{};
  const tripRows = [];
  if (t.start_location) tripRows.push(row('Start location', t.start_location));
  if (t.start_date)     tripRows.push(row('Start date', t.start_date));
  tripRows.push(row('Start mileage', t.start_mileage));
  if (t.finish_location)tripRows.push(row('Finish location', t.finish_location));
  if (t.finish_date)    tripRows.push(row('Finish date', t.finish_date));
  tripRows.push(row('Finish mileage', t.finish_mileage));
  rv.push(`<div class="rv-title">Trip</div><div class="kv">${tripRows.join('')}</div>`);

  // Loads
  const loads = payload.loads||[];
  if (loads.length){
    rv.push(`<div class="rv-title">Loads (${loads.length})</div>`);
    loads.forEach((L, idx)=>{
      const Lrows=[];
      if (L.date)     Lrows.push(row('Date', L.date));
      if (L.pickup)   Lrows.push(row('Pickup', L.pickup));
      if (L.delivery) Lrows.push(row('Delivery', L.delivery));
      if (L.partial!=='' && L.partial!=null) Lrows.push(row('Partial (qty)', L.partial));
      if (L.tarp!=='' && L.tarp!=null)       Lrows.push(row('Tarp (qty)', L.tarp));
      rv.push(`<div class="kv rv-load"><div class="kv-row"><div class="kv-k">Load</div><div>#${idx+1}</div></div>${Lrows.join('')}</div>`);
    });
  }

  // Expenses
  const exps = (payload.expenses||[]).filter(e=> (e.name&&e.name.trim()) || (e.price!=='' && !Number.isNaN(Number(e.price))));
  if (exps.length){
    rv.push(`<div class="rv-title">Expenses (${exps.length})</div>`);
    exps.forEach((e,idx)=> rv.push(`<div class="kv rv-load">
      <div class="kv-row"><div class="kv-k">Item</div><div>#${idx+1}</div></div>
      ${e.name?row('Name',e.name):''}
      ${e.price!==''?row('Price',e.price):''}
    </div>`));
  }

  document.getElementById('reviewBox').innerHTML = rv.join('');
  document.getElementById('rawJson').textContent = JSON.stringify(payload,null,2);

  function row(k,v){ return `<div class="kv-row"><div class="kv-k">${esc(k)}</div><div>${esc(String(v))}</div></div>`; }
}

// Payload
function buildPayload(forPreview=false){
  const user = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
  const meta = tg ? { initData: tg.initData || '', user } : {};
  const client_token = `${user?.id||'anon'}_${Date.now()}`;

  const loads = state.loads.filter(isLoadFilled);
  const expenses = state.expenses.filter(e=> (e.name&&e.name.trim()) || (e.price!=='' && !Number.isNaN(Number(e.price))) );

  const out = { _tg_meta: meta, trip: { ...state.trip }, loads, expenses, client_token };
  if (!forPreview) state.client_token = client_token;
  return out;
}

// Submit + dedupe
let inFlight=false;
function localKey(userId){ return `trip_submit_lock_${userId}`; }
async function submitTrip(){
  if (inFlight) return;
  if (!validateTrip() || !validateLoads()) return;

  const userId = tg?.initDataUnsafe?.user?.id || 'anon';
  const lk = localKey(userId), last = Number(localStorage.getItem(lk)||'0'), now = Date.now();
  if (now-last<120000){ showSubmitError('You have recently submitted a trip. Please try again in a minute.'); return; }

  const payload = buildPayload(false);
  clearSubmitError(); lockSubmit(true);
  try{
    const res = await fetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if (!res.ok){ throw new Error(`HTTP ${res.status}: ${await res.text()}`); }
    localStorage.setItem(lk,String(now));
    if (tg){ tg.showPopup({message:'Submitted! Thank you.'}); tg.close(); } else alert('Submitted!');
  }catch(e){ showSubmitError(e.message||'Submit error'); }
  finally{ lockSubmit(false); }
}
function lockSubmit(on){ inFlight=on; const b=document.getElementById('submitBtn'); b.disabled=on; b.textContent=on?'Submitting…':'Submit'; }
function showSubmitError(msg){ const e=document.getElementById('submit_err'); e.textContent=msg; e.hidden=false; }
function clearSubmitError(){ document.getElementById('submit_err').hidden=true; }

// utils
function esc(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

// init
(function(){
  if (state.loads.length===0) state.loads=[{date:'',pickup:'',delivery:'',partial:'',tarp:''}];
  renderLoads();
})();
</script>
</body>
</html>
